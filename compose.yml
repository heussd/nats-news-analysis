services:
    nats-server:
        image: docker.io/nats:2.10
        ports:
            - '4222:4222' # 4222 is for clients.
            - '8222:8222' # 8222 is an HTTP management port for information reporting.
            - '6222:6222' # 6222 is a routing port for clustering.
        volumes:
            - './nats-persistence/:/data'
        command: '--jetstream --http_port 8222 --store_dir /data'
    fullfeedrss:
        image: docker.io/heussd/fivefilters-full-text-rss:latest
        deploy:
            replicas: 2
        environment:
            # Leave empty to disable admin section
            - FTR_ADMIN_PASSWORD=
        volumes:
            - 'rss-cache:/var/www/html/cache'

    loadbalancer:
        image: docker.io/nginx
        volumes:
            - './loadbalancer/nginx.conf:/etc/nginx/nginx.conf'
        depends_on:
            - fullfeedrss
        ports:
            - '80:80'
    feed-feeder:
        image: ghcr.io/heussd/nats-news-analysis/feed-feeder:latest
        environment:
            - NATS_SERVER=http://nats-server:4222
        volumes:
            - type: bind
              source: ./urls.txt
              target: /urls.txt
              consistency: cached
              read_only: true
    article-feeder:
        image: ghcr.io/heussd/nats-news-analysis/article-feeder:latest
        deploy:
            replicas: 1
        environment:
            - 'NATS_SERVER=nats-server:4222'
        restart: always
    keyword-matcher:
        deploy:
            replicas: 9
        image: ghcr.io/heussd/nats-news-analysis/keyword-matcher:latest
        environment:
            - 'NATS_SERVER=nats-server:4222'
            - 'FULLTEXTRSS_SERVER=http://loadbalancer:80'
    raindrop-integration:
        image: ghcr.io/heussd/nats-news-analysis/raindrop-integration:latest
        environment:
            - 'NATS_SERVER=nats-server:4222'
        env_file:
            - .env

volumes:
    rss-cache:
