services:
    nats-server:
        image: docker.io/nats:2.12
        ports:
            - '4222:4222' # 4222 is for clients.
            - '8222:8222' # 8222 is an HTTP management port for information reporting.
            - '6222:6222' # 6222 is a routing port for clustering.
        volumes:
            - './nats-persistence/:/data'
        command: '--jetstream --http_port 8222 --store_dir /data'
    fullfeedrss:
        image: docker.io/heussd/fivefilters-full-text-rss:latest
        mem_limit: 3G
        restart: always
        deploy:
            replicas: 2
        environment:
            # Leave empty to disable admin section
            - FTR_ADMIN_PASSWORD=
        volumes:
            - 'rss-cache:/var/www/html/cache'
    feed-feeder:
        image: ghcr.io/heussd/nats-news-analysis/feed-feeder:latest
        restart: always
        environment:
            - NATS_URL=http://nats-server:4222
            - URLS_URL=${URLS_URL}
    article-feeder:
        image: ghcr.io/heussd/nats-news-analysis/article-feeder:latest
        deploy:
            replicas: 3
        environment:
            - NATS_URL=nats-server:4222
        restart: always
    news-feeder:
        deploy:
            replicas: 2
        restart: always
        image: ghcr.io/heussd/nats-news-analysis/news-feeder:latest
        environment:
            - NATS_URL=nats-server:4222
            - FULLTEXTRSS_SERVER=http://fullfeedrss:80
    keyword-matcher:
        deploy:
            replicas: 6
        restart: always
        image: ghcr.io/heussd/nats-news-analysis/keyword-matcher:latest
        environment:
            - NATS_URL=nats-server:4222
            - KEYWORDS_FILE_URL=${KEYWORDS_FILE_URL}
            - NATS_SUBSCRIBE_SUBJECT=news.*
            - NATS_CONSUMER=default
            - NATS_PUBLISH_SUBJECT=match-urls
    raindrop-integration:
        image: ghcr.io/heussd/nats-news-analysis/raindrop-integration:latest
        restart: always
        environment:
            - NATS_URL=nats-server:4222
            - RAINDROP_COLLECTION=${RAINDROP_COLLECTION}
            - RAINDROP_ACCESS_TOKEN=${RAINDROP_ACCESS_TOKEN}
    nats-indexer:
        deploy:
            replicas: 1
        restart: always
        image: ghcr.io/heussd/nats-news-analysis/nats-indexer:latest
        environment:
            - 'NATS_URL=nats-server:4222'
            - 'AI_SEARCH_ENDPOINT=${AI_SEARCH_ENDPOINT}'
            - 'AI_SEARCH_API_KEY=${AI_SEARCH_API_KEY}'
            - 'AI_SEARCH_API_VERSION=${AI_SEARCH_API_VERSION}'
    search-mcp-server:
        deploy:
            replicas: 0
        image: ghcr.io/heussd/nats-news-analysis/search-mcp-server:latest
        ports:
            - '8000:8000'
        environment:
            - 'AI_SEARCH_ENDPOINT=${AI_SEARCH_ENDPOINT}'
            - 'AI_SEARCH_API_KEY=${AI_SEARCH_API_KEY}'
            - 'AI_SEARCH_API_VERSION=${AI_SEARCH_API_VERSION}'
            - 'RAINDROP_RSS_FEED=${RAINDROP_RSS_FEED}'
    watchtower:
        image: containrrr/watchtower
        restart: always
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        command: --interval 7200
volumes:
    rss-cache:
